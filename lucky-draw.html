<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lucky Draw — Draw Only (Luxury+ Edition)</title>
<style>
  :root{
    --bg:#0a0c0f; --panel:#0e1116; --text:#f4f5f7; --muted:#b9c0cf;
    --gold:#d4af37; --gold-deep:#b38b2b; --gold-soft:#f0d98a;
    --accent:#e3c15a; --accent2:#8f6b2e;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:var(--bg);overflow-x:hidden}

  /* Luxury background */
  .bg-luxe{position:fixed; inset:-10% -10% -10% -10%; z-index:-2; pointer-events:none;
    background:
      radial-gradient(1200px 800px at 20% 10%, rgba(255,255,255,.06), transparent 60%),
      radial-gradient(1000px 700px at 80% 30%, rgba(255,255,255,.04), transparent 60%),
      radial-gradient(1200px 900px at 30% 80%, rgba(255,255,255,.035), transparent 60%),
      linear-gradient(135deg, #0b0e12 0%, #0a0c0f 50%, #0e1015 100%);
    filter: contrast(1.02) saturate(1.05);
  }
  .bg-luxe::before{content:""; position:absolute; inset:-15%;
    background:
      radial-gradient(45% 35% at 20% 15%, rgba(212,175,55,.16), transparent 60%),
      radial-gradient(50% 40% at 75% 20%, rgba(240,217,138,.14), transparent 62%),
      radial-gradient(60% 45% at 40% 85%, rgba(179,139,43,.10), transparent 60%);
    mix-blend-mode: screen; animation:luxe-sway 28s ease-in-out infinite alternate; filter:blur(28px)
  }
  .bg-luxe::after{content:""; position:absolute; inset:0;
    background:
      repeating-radial-gradient(circle at 30% 30%, rgba(255,255,255,.06) 0 1px, transparent 1px 6px),
      repeating-radial-gradient(circle at 70% 60%, rgba(255,255,255,.05) 0 1px, transparent 1px 7px);
    opacity:.06; animation:luxe-stars 32s linear infinite;
  }
  @keyframes luxe-sway{0%{transform:translate3d(-1%,-1%,0) scale(1.02)}100%{transform:translate3d(1%,1%,0) scale(1.05)}}
  @keyframes luxe-stars{from{transform:translateY(0)}to{transform:translateY(-40px)}}

  .wrap{max-width:1220px;margin:24px auto;padding:18px 20px}
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
  h1{margin:0;font-weight:900;letter-spacing:.3px;font-size:clamp(18px,2.4vw,26px);
    background:linear-gradient(180deg, var(--gold-soft), var(--gold)); -webkit-background-clip:text; background-clip:text; color:transparent;
    text-shadow:0 2px 16px rgba(212,175,55,.12)}
  a.btnlink{padding:10px 14px;border-radius:10px;border:1px solid rgba(212,175,55,.45);
    background:linear-gradient(180deg, rgba(212,175,55,.10), rgba(212,175,55,.06)); color:var(--text); text-decoration:none;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.15), 0 6px 20px rgba(0,0,0,.35)}

  /* Panel */
  .panel{background:linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02));
    border:1px solid rgba(212,175,55,.30); border-radius:16px; padding:14px 16px;margin-bottom:14px;
    box-shadow:0 16px 48px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.05), inset 0 1px 0 rgba(255,255,255,.12)}
  .controls{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;align-items:end}
  .ctl{grid-column:span 2; min-width:140px}
  .ctl.wide{grid-column:span 3}
  @media(max-width:980px){ .ctl{grid-column:span 6} .ctl.wide{grid-column:span 6} }
  @media(max-width:560px){ .ctl{grid-column:span 12} .ctl.wide{grid-column:span 12} }

  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input,select{width:100%;background:rgba(255,255,255,.06);color:var(--text);border:1px solid rgba(212,175,55,.32);border-radius:12px;padding:10px;box-shadow:inset 0 1px 0 rgba(255,255,255,.08)}

  /* ✅ Fix: ให้ตัวเลือกใน dropdown มองเห็นชัดเจนตอนเปิดเมนู */
  select{ -webkit-text-fill-color: var(--text); }
  select option,
  select optgroup{
    background:#12151b;     /* พื้นหลังเมนูแบบดาร์ก */
    color:#f4f5f7;          /* ตัวอักษรสว่างให้อ่านง่าย */
  }
  select option:checked,
  select option:hover,
  select option:focus{
    background:#2a2f3a;     /* สีไฮไลต์ตอนโฮเวอร์/เลือก */
    color:#ffffff;
  }
  @supports (color-scheme: dark){
    select, select option{ color-scheme: dark; }
  }

  .btn{appearance:none;border:none;border-radius:12px;padding:11px 16px;font-weight:900;cursor:pointer;color:#1a1508; letter-spacing:.25px;
    background:linear-gradient(180deg, #ffe9a3, #f0cd62 45%, #cfa43a 46%, #e5c05a 100%);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.9), 0 8px 24px rgba(212,175,55,.35), 0 1px 0 rgba(255,255,255,.4);
    border:1px solid rgba(179,139,43,.65)}
  .btn.ghost{background:linear-gradient(180deg, rgba(212,175,55,.12), rgba(212,175,55,.05)); color:var(--text); border:1px solid rgba(212,175,55,.35); box-shadow:inset 0 1px 0 rgba(255,255,255,.15)}

  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .chip{background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05)); border:1px solid rgba(212,175,55,.28); color:var(--text);
    padding:6px 10px;border-radius:999px;font-size:12px; box-shadow:inset 0 1px 0 rgba(255,255,255,.08)}

  /* Stage */
  .stage{position:relative; display:grid; place-items:center; padding:16px 0 24px; margin-bottom:16px;
    background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border-radius:22px;
    box-shadow:0 28px 80px rgba(0,0,0,.65), inset 0 0 0 1px rgba(255,255,255,.04); overflow:hidden}
  .stage::before{content:""; position:absolute; inset:10px; border-radius:18px;
    background:linear-gradient(180deg, rgba(212,175,55,.16), rgba(212,175,55,.05));
    border:1px solid rgba(212,175,55,.35); box-shadow:inset 0 1px 0 rgba(255,255,255,.18); pointer-events:none}
  .pointer{width:0;height:0;border-left:18px solid transparent;border-right:18px solid transparent; border-bottom:30px solid var(--gold);
    margin:12px auto 10px auto; filter:drop-shadow(0 10px 16px rgba(212,175,55,.35))}

  /* Logo (simple path import) */
  .brand{position:relative; z-index:1; margin:8px 0 6px; display:flex; align-items:center; justify-content:center}
  .brand img{max-width: clamp(160px, 30vw, 320px); height:auto; display:block; filter: drop-shadow(0 6px 14px rgba(0,0,0,.45))}

  #wheel{width:clamp(360px,70vw,860px); height:clamp(360px,70vw,860px);
    background:radial-gradient(140% 100% at 50% 0%, rgba(255,255,255,.10), transparent 50%), rgba(255,255,255,.06);
    border:1px solid rgba(212,175,55,.30); border-radius:50%; box-shadow:0 24px 70px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.08)}

  /* Winners + History */
  .board{display:grid; grid-template-columns:1fr; gap:12px; margin-bottom:16px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); border:1px solid rgba(212,175,55,.28);
    border-radius:16px; padding:14px 16px; box-shadow:0 18px 60px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.08)}
  .board-head{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:8px}
  .winners{display:grid;grid-template-columns:1fr;gap:10px;min-height:64px}
  .win{position:relative; padding:18px 22px;border:1px solid rgba(212,175,55,.34); border-radius:14px;
    background:linear-gradient(180deg, rgba(212,175,55,.22), rgba(212,175,55,.10)), radial-gradient(200% 120% at 0% 50%, rgba(255,255,255,.10), transparent 40%);
    font-size:clamp(22px, 2.8vw, 34px); font-weight:1000; letter-spacing:.35px; text-shadow:0 2px 0 rgba(0,0,0,.25); overflow:hidden}
  .win .pos{font-size:clamp(12px,1.6vw,16px); opacity:.88; font-weight:700}

  .sparkles{position:absolute; inset:0; pointer-events:none; overflow:hidden}
  .sparkles i{position:absolute; width:6px; height:6px; background: radial-gradient(circle, #fff6cc 0%, #f0cd62 45%, #cfa43a 70%, transparent 72%);
    border-radius:50%; filter:drop-shadow(0 0 6px rgba(212,175,55,.9))}
  @keyframes floatUp{0%{transform:translateY(10px) scale(.6); opacity:0}
                     10%{opacity:1}
                     100%{transform:translateY(-28px) scale(1.1); opacity:0}}

  .history{display:grid;gap:10px}
  .hist-item{border:1px solid rgba(212,175,55,.24);border-radius:12px;padding:10px 12px;background:rgba(255,255,255,.05)}
  .hist-head{display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:6px}
  .hist-meta{font-size:12px;color:var(--muted)}
  .hist-wins{font-size:14px}

  .toast{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:100}
  .toast.show{display:flex}
  .toast-inner{position:relative; backdrop-filter: blur(10px);
    background:linear-gradient(180deg, rgba(26,21,8,.72), rgba(26,21,8,.62));
    border:1px solid rgba(212,175,55,.45); padding:26px 30px; border-radius:20px; text-align:center;
    box-shadow:0 30px 100px rgba(212,175,55,.35), inset 0 0 0 1px rgba(255,255,255,.10);
    transform:scale(.9); opacity:0; animation:pop .45s ease forwards}
  .toast-name{font-size:clamp(32px,5.4vw,56px); font-weight:1000; letter-spacing:.55px;
    background:linear-gradient(180deg, var(--gold-soft), var(--gold)); -webkit-background-clip:text; background-clip:text; color:transparent;
    text-shadow:0 2px 16px rgba(212,175,55,.18)}
  .toast-pos{font-size:clamp(14px,1.8vw,20px); color:var(--muted); margin-top:6px}
  .toast-sparkles{position:absolute; inset:-10px; pointer-events:none}
  .toast-sparkles i{position:absolute; width:8px; height:8px; background: radial-gradient(circle, #fff6cc 0%, #f0cd62 45%, #cfa43a 70%, transparent 72%);
    border-radius:50%; filter:drop-shadow(0 0 8px rgba(212,175,55,.95))}
  @keyframes pop{to{transform:scale(1); opacity:1}}
  .btnrow{display:flex;gap:8px;flex-wrap:wrap}
</style>
</head>
<body>
<div class="bg-luxe"></div>

<div class="wrap">
  <div class="topbar">
    <h1>YOUR COMPANY LUCKY DRAW 2025</h1>
    <a class="btnlink" href="./lucky-setup.html">⟵ Back to Setup</a>
  </div>

  <!-- Controls -->
  <div class="panel">
    <div class="controls">
      <div class="ctl">
        <label>Winners per Round</label>
        <input id="num" type="number" min="1" value="1" />
      </div>
      <div class="ctl">
        <label>Countdown (seconds)</label>
        <input id="secs" type="number" min="0" value="0" />
      </div>
      <div class="ctl wide">
        <label>Group to Draw</label>
        <select id="group">
          <option value="*">All</option>
        </select>
      </div>
      <div class="ctl wide" style="display:flex;gap:10px;align-items:center">
        <label style="display:flex;gap:10px;align-items:center;margin:0">
          <input id="remove" type="checkbox" checked /> Remove winners from pool
        </label>
        <button class="btn" id="start">Start</button>
        <button class="btn ghost" id="reload">Reload</button>
      </div>
    </div>

    <div class="chips">
      <div class="chip">Pool: <span id="poolC">0</span></div>
      <div class="chip" id="chip1">Pos 1 left: <span id="pos1C">0</span></div>
      <div class="chip" id="chip2">Pos 2 left: <span id="pos2C">0</span></div>
      <div class="chip">Filter: <span id="filtC">0</span></div>
      <div class="chip" id="msg" style="color:#e6d7a6">Ready to draw</div>
    </div>
  </div>

  <!-- Stage -->
  <div class="stage">
    <div class="brand">
      <img id="brandLogo" alt="Brand logo" src="./assets/logo.png" />
    </div>
    <div class="pointer"></div>
    <canvas id="wheel" width="860" height="860" aria-label="wheel"></canvas>
  </div>

  <!-- Winners + History -->
  <div class="board">
    <section class="card">
      <div class="board-head">
        <div class="muted tiny">Winners (latest round only)</div>
        <div class="btnrow">
          <button class="btn ghost" id="copy">Copy</button>
          <button class="btn ghost" id="export">Export (.txt)</button>
          <button class="btn ghost" id="clearWins">Clear</button>
        </div>
      </div>
      <div id="winners" class="winners"></div>
    </section>

    <section class="card">
      <div class="board-head">
        <div class="card-title" style="font-weight:800">Draw History</div>
        <div class="btnrow">
          <button class="btn ghost" id="copyHist">Copy History</button>
          <button class="btn ghost" id="exportHist">Export History (.txt)</button>
          <button class="btn ghost" id="clearHist">Clear History</button>
        </div>
      </div>
      <div id="history" class="history tiny muted">No history yet</div>
    </section>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast"><div class="toast-inner">
  <div class="toast-name" id="toastName">—</div>
  <div class="toast-pos" id="toastPos">—</div>
  <div class="toast-sparkles" id="toastSparkles"></div>
</div></div>

<script>
(() => {
  const $=id=>document.getElementById(id);
  const KEY_POOL='LD_POOL', KEY_POSMAP='LD_POSMAP', KEY_HISTORY='LD_HISTORY';

  const numInput=$('num'), secsInput=$('secs'), groupSel=$('group'), removeChk=$('remove');
  const poolC=$('poolC'), pos1C=$('pos1C'), pos2C=$('pos2C'), filtC=$('filtC'), msg=$('msg');
  const chip1=$('chip1'), chip2=$('chip2');
  const winnersBox=$('winners'), histBox=$('history');

  const canvas=$('wheel'), ctx=canvas.getContext('2d');
  const toast=$('toast'), toastName=$('toastName'), toastPos=$('toastPos'), toastSparkles=$('toastSparkles');

  let pool=[];       // [{name, positionRaw, positionLabel}]
  let drawHistory=[]; // [{time, group, winners:[{name,pos}]}]
  let wheelAngle=0;

  const brandLogoEl = $('brandLogo');
  if (brandLogoEl) brandLogoEl.onerror = () => { brandLogoEl.style.display = 'none'; };

  let audioCtx=null;
  function ensureCtx(){ if(!audioCtx){ try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }catch(_){} } }
  function playChime(){
    ensureCtx(); if(!audioCtx) return;
    const now=audioCtx.currentTime;
    const seq=[{f:880,t:.00,d:.10},{f:1318.5,t:.08,d:.12},{f:1046.5,t:.16,d:.16}];
    seq.forEach(({f,t,d})=>{
      const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
      o.type='triangle'; o.frequency.value=f;
      g.gain.setValueAtTime(0, now+t);
      g.gain.linearRampToValueAtTime(0.36, now+t+0.02);
      g.gain.exponentialRampToValueAtTime(0.0008, now+t+d);
      const lp=audioCtx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=4000;
      o.connect(lp); lp.connect(g); g.connect(audioCtx.destination); o.start(now+t); o.stop(now+t+d+0.02);
    });
  }

  function loadData(){
    try{ pool = JSON.parse(localStorage.getItem(KEY_POOL)||'[]'); }catch{ pool=[]; }
    try{ drawHistory = JSON.parse(localStorage.getItem(KEY_HISTORY)||'[]'); }catch{ drawHistory=[]; }
    updateCounters(true); drawWheel(); renderHistory();
    msg.textContent='Data loaded'; setTimeout(()=>msg.textContent='Ready to draw',1200);
  }
  function savePool(){ localStorage.setItem(KEY_POOL, JSON.stringify(pool)); }
  function saveHistory(){ localStorage.setItem(KEY_HISTORY, JSON.stringify(drawHistory)); }

  function currentMapping(){
    try{
      const mapStr=localStorage.getItem(KEY_POSMAP)||'';
      const pairs = mapStr.split(',').map(x=>x.trim()).filter(Boolean).map(x=>x.split('=').map(s=>s.trim()));
      return Object.fromEntries(pairs.filter(p=>p.length>=2));
    }catch(_){ return {}; }
  }
  function tagCounts(){
    const counts = {};
    for(const p of pool){
      const raw=(p.positionRaw||'').trim();
      counts[raw] = (counts[raw]||0) + 1;
    }
    return counts;
  }
  function displayLabel(raw, map){
    if(!raw) return '';
    const key = (raw in map) ? raw : (raw.toLowerCase?.() in map ? raw.toLowerCase() : null);
    return key ? map[key] : raw;
  }
  function populateGroupAndChips(){
    const map = currentMapping();
    const counts = tagCounts();
    const entries = Object.entries(counts).sort((a,b)=>b[1]-a[1]);

    const keep = groupSel.value;
    groupSel.innerHTML = '<option value="*">All</option>';
    for(const [raw, n] of entries){
      const label = displayLabel(raw, map) || raw || '—';
      const opt = document.createElement('option');
      opt.value = raw;
      opt.textContent = label;
      groupSel.appendChild(opt);
    }
    if([...groupSel.options].some(o=>o.value===keep)) groupSel.value=keep;

    const one = entries[0] || ['',0];
    const two = entries[1] || ['',0];
    const oneLabel = one[0] ? displayLabel(one[0], map) : '—';
    const twoLabel = two[0] ? displayLabel(two[0], map) : '—';
    chip1.innerHTML = `${oneLabel} left: <span id="pos1C">${one[1]||0}</span>`;
    chip2.innerHTML = `${twoLabel} left: <span id="pos2C">${two[1]||0}</span>`;
    window.pos1C = document.getElementById('pos1C');
    window.pos2C = document.getElementById('pos2C');
  }

  function updateCounters(rebuild=false){
    poolC.textContent = pool.length;
    filtC.textContent = getAllowedIndices().length;

    if(rebuild){
      populateGroupAndChips();
    }else{
      const c = tagCounts();
      const entries = Object.entries(c).sort((a,b)=>b[1]-a[1]);
      const one = entries[0] || ['',0];
      const two = entries[1] || ['',0];
      if(pos1C) pos1C.textContent = one[1]||0;
      if(pos2C) pos2C.textContent = two[1]||0;
    }
  }

  function getAllowedIndices(){
    const g = groupSel.value;
    const idxs=[];
    for(let i=0;i<pool.length;i++){
      const r=(pool[i].positionRaw||'').trim();
      if(g==='*' || r===g) idxs.push(i);
    }
    return idxs;
  }

  function wheelItems(){
    const idxs=getAllowedIndices();
    const show=(idxs.length? idxs : pool.map((_,i)=>i));
    return show.map(i=>({ idx:i, label: pool[i].name + (pool[i].positionLabel? ' · '+pool[i].positionLabel : '') }));
  }
  function drawCrown(ctx, x, y, w, h){
    ctx.save(); ctx.translate(x,y);
    ctx.beginPath();
    ctx.moveTo(-w/2, h/2);
    ctx.lineTo(-w/3, -h/6);
    ctx.lineTo(-w/9, -h/8);
    ctx.lineTo(0, -h/2);
    ctx.lineTo(w/9, -h/8);
    ctx.lineTo(w/3, -h/6);
    ctx.lineTo(w/2, h/2);
    ctx.closePath();
    const grd=ctx.createLinearGradient(-w/2, -h/2, w/2, h/2);
    grd.addColorStop(0, '#fff6cc'); grd.addColorStop(0.5, '#e3c15a'); grd.addColorStop(1, '#b88a2a');
    ctx.fillStyle=grd; ctx.fill(); ctx.strokeStyle='rgba(255,255,255,.4)'; ctx.lineWidth=1; ctx.stroke();
    ctx.beginPath();
    if(ctx.roundRect){ ctx.roundRect(-w/2, h/2-6, w, 12, 6); } else { ctx.rect(-w/2, h/2-6, w, 12); }
    ctx.fillStyle='rgba(0,0,0,.15)'; ctx.fill(); ctx.restore();
  }
  function drawWheel(highlight=-1){
    const W=canvas.width,H=canvas.height,cx=W/2,cy=H/2,R=Math.min(cx,cy)-14;
    ctx.clearRect(0,0,W,H);
    const items=wheelItems(); const N=Math.max(1, items.length); const arc=(Math.PI*2)/N;
    ctx.save(); ctx.translate(cx,cy); ctx.rotate(wheelAngle);
    for(let k=0;k<N;k++){
      const a0=k*arc, a1=(k+1)*arc;
      ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,R,a0,a1); ctx.closePath();
      ctx.fillStyle= k===highlight? 'rgba(212,175,55,.55)' : (k%2? 'rgba(227,193,90,.28)' : 'rgba(143,107,46,.22)');
      ctx.strokeStyle='rgba(255,255,255,.22)'; ctx.lineWidth=1; ctx.fill(); ctx.stroke();
      ctx.save(); const mid=a0+(arc/2); ctx.rotate(mid);
      ctx.textAlign='right'; ctx.textBaseline='middle'; ctx.fillStyle='#fffbea';
      ctx.font = '16px Inter,system-ui,Segoe UI,Roboto,Arial';
      const txt = items[k].label.length>48? items[k].label.slice(0,45)+'…' : items[k].label;
      ctx.fillText(txt, R-16, 0);
      ctx.restore();
    }
    ctx.beginPath(); ctx.arc(0,0,46,0,Math.PI*2);
    const grd = ctx.createRadialGradient(0,0,8, 0,0,46);
    grd.addColorStop(0,'#fff6cc'); grd.addColorStop(1,'#caa443');
    ctx.fillStyle=grd; ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,.35)'; ctx.lineWidth=1; ctx.stroke();
    drawCrown(ctx, 0, 3, 42, 32);
    ctx.restore();
  }
  function spinToIndex(targetIdx){
    return new Promise(resolve=>{
      const items=wheelItems(); const N=items.length; if(N===0) return resolve();
      const arc=(Math.PI*2)/N;
      const targetCenter=(targetIdx+0.5)*arc;
      const baseAngle=(Math.PI*1.5) - targetCenter;
      const extraTurns=4 + Math.random()*2;
      const start=performance.now(); const dur=2900 + Math.random()*750;
      const startAngle=wheelAngle; const endAngle = baseAngle + extraTurns * 2*Math.PI;
      const easeOut=t=>1-Math.pow(1-t,3);
      function frame(t){
        const p=Math.min(1,(t-start)/dur);
        wheelAngle = startAngle + (endAngle - startAngle)*easeOut(p);
        drawWheel();
        if(p<1) requestAnimationFrame(frame); else { wheelAngle=endAngle%(2*Math.PI); drawWheel(targetIdx); resolve(); }
      }
      requestAnimationFrame(frame);
    });
  }

  function sprinkle(container, count){
    container.innerHTML='';
    for(let i=0;i<count;i++){
      const s=document.createElement('i');
      const x=Math.random()*100, y=Math.random()*100;
      const delay=(Math.random()*0.25).toFixed(2);
      const dur=(0.9+Math.random()*0.8).toFixed(2);
      s.style.left=x+'%'; s.style.top=y+'%';
      s.style.animation=`floatUp ${dur}s ease-out ${delay}s forwards`;
      container.appendChild(s);
    }
    setTimeout(()=>{ container.innerHTML=''; }, 2200);
  }

  function addWinnerRow(name, pos){
    const d=document.createElement('div'); d.className='win';
    d.innerHTML = `<span>${escapeHTML(name)}</span> <span class="pos">· ${escapeHTML(pos||'—')}</span><div class="sparkles"></div>`;
    $('winners').appendChild(d);
    sprinkle(d.querySelector('.sparkles'), 18);
  }

  function showToast(name, pos){
    toastName.textContent=name;
    toastPos.textContent=pos? 'Position: '+pos : '';
    toast.classList.add('show');
    sprinkle(toastSparkles, 28);
    setTimeout(()=> toast.classList.remove('show'), 2100);
  }

  function clearWinnerList(){ $('winners').innerHTML=''; }
  function pickOneIndex(indices){ const u=new Uint32Array(1); crypto.getRandomValues(u); return indices[u[0] % indices.length]; }

  async function doDraw(){
    const n = Math.max(1, parseInt(numInput.value)||1);
    const secs = Math.max(0, parseInt(secsInput.value)||0);
    let allow = getAllowedIndices();
    if(!pool.length){ msg.textContent='No names in pool'; return; }
    if(!allow.length){ msg.textContent='No members left in selected group'; return; }
    if(removeChk.checked && n>allow.length){ msg.textContent=`Winners (${n}) exceed available (${allow.length})`; return; }

    clearWinnerList();

    if(secs>0){ for(let i=secs;i>0;i--){ msg.textContent='Drawing in '+i+' s…'; await new Promise(r=>setTimeout(r,1000)); } }

    const roundWinners=[];
    for(let i=0;i<n;i++){
      allow=getAllowedIndices(); if(!allow.length) break;

      drawWheel();
      const pickIdx = pickOneIndex(allow);
      const items = wheelItems();
      const wheelIndex = items.findIndex(it => it.idx === pickIdx);
      await spinToIndex(wheelIndex);

      const item = pool[pickIdx];
      const posLabel = item.positionLabel || '';
      showToast(item.name, posLabel);
      addWinnerRow(item.name, posLabel);
      roundWinners.push({name:item.name, pos:posLabel});

      playChime();

      if(removeChk.checked){
        pool.splice(pickIdx,1);
        savePool();
        updateCounters(true);
      }
      drawWheel();
      if(i<n-1) await new Promise(r=>setTimeout(r,900));
    }

    const sel = groupSel.value==='*' ? 'All' : (groupSel.options[groupSel.selectedIndex]?.textContent || 'Group');
    drawHistory.unshift({ time:new Date().toLocaleString('en-US'), group:sel, winners:roundWinners });
    saveHistory();
    renderHistory();

    msg.textContent='Draw complete';
    setTimeout(()=>msg.textContent='Ready to draw',1500);
  }

  function renderHistory(){
    if(!drawHistory.length){ histBox.classList.add('muted'); histBox.textContent='No history yet'; return; }
    histBox.classList.remove('muted');
    histBox.innerHTML = drawHistory.map((h,idx)=>{
      const list = h.winners.map(w=>`${escapeHTML(w.name)}${w.pos? ' · '+escapeHTML(w.pos):''}`).join(', ');
      return `
        <div class="hist-item">
          <div class="hist-head">
            <div class="hist-meta">#${drawHistory.length-idx} • ${escapeHTML(h.time)} • ${escapeHTML(h.group)} • ${h.winners.length} winner(s)</div>
          </div>
          <div class="hist-wins">${list || '-'}</div>
        </div>
      `;
    }).join('');
  }
  function escapeHTML(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  $('start').addEventListener('click', doDraw);
  $('reload').addEventListener('click', loadData);
  $('group').addEventListener('change', ()=>{ updateCounters(); drawWheel(); });

  $('copy').addEventListener('click', ()=>{
    const txt=[...$('winners').children].map(el=>el.textContent.trim()).join('\n');
    if(!txt) return; navigator.clipboard.writeText(txt);
    msg.textContent='Copied latest winners'; setTimeout(()=>msg.textContent='Ready to draw',1200);
  });
  $('export').addEventListener('click', ()=>{
    const txt=[...$('winners').children].map(el=>el.textContent.trim()).join('\n'); if(!txt) return;
    const blob=new Blob([txt],{type:'text/plain;charset=utf-8'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='winners_latest.txt'; document.body.appendChild(a); a.click();
    setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},500);
  });
  $('clearWins').addEventListener('click', ()=>{ $('winners').innerHTML=''; });

  $('copyHist').addEventListener('click', ()=>{
    if(!drawHistory.length) return;
    const lines = drawHistory.map(h => `${h.time} | ${h.group} | ${h.winners.map(w=>w.name + (w.pos? ' · '+w.pos:'')).join(', ')}`);
    navigator.clipboard.writeText(lines.join('\n'));
    msg.textContent='Copied history'; setTimeout(()=>msg.textContent='Ready to draw',1200);
  });
  $('exportHist').addEventListener('click', ()=>{
    if(!drawHistory.length) return;
    const lines = drawHistory.map(h => `${h.time} | ${h.group} | ${h.winners.map(w=>w.name + (w.pos? ' · '+w.pos:'')).join(', ')}`);
    const blob=new Blob([lines.join('\n')],{type:'text/plain;charset=utf-8'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='winners_history.txt'; document.body.appendChild(a); a.click();
    setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},500);
  });
  $('clearHist').addEventListener('click', ()=>{
    if(!drawHistory.length) return;
    if(confirm('Clear all history?')){ drawHistory=[]; saveHistory(); renderHistory(); }
  });

  loadData();
})();
</script>
</body>
</html>
